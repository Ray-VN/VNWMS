{% extends 'warehouse/bases/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load i18n %}
{% block title %} {% trans "Search Product Order" %} {% endblock %}
{% block css %}
    <style>

        #jsGrid {
            font-size: 16px;
        }

        #workOrder {
            font-size: 16px;
            width: 300px;
            height: 40px;

        }


    </style>

    <script>
    $(document).ready(function() {

        const searchParams = new URLSearchParams(window.location.search);
        const workOrder = searchParams.get("product_order");

        if (workOrder) {
            // Tự động điền vào thanh tìm kiếm
            $("#workOrder").val(workOrder);

            $.ajax({
            url: `{% url 'work_order_search' %}`,
            method: 'GET',
            data: {
                search: workOrder,
                product_order: searchParams.get('product_order'),
            },
            success: function(response) {
                // Cập nhật dữ liệu cho jsGrid
                $("#jsGrid").jsGrid("option", "data", response);
            },
            error: function(xhr, status, error) {
                console.error("Error fetching data:", error);
            }
        });
        }

        $("#jsGrid").jsGrid({
            width: "95%",
            height: "500px",
            noDataContent: "{% trans "Not found" %}",
            inserting: false,
            editing: false,
            sorting: true,
            paging: true,
            pageSize: 20,
            fields: [
                { name: "bin__area__warehouse__wh_code", title: "{% trans "Warehouse" %}", type: "text", css: "text-center", width: 30 },
                { name: "product_order", title: "{% trans "Product Order" %}", type: "text", css: "text-center", width: 30 },
                { name: "purchase_no", title: "{% trans "Purchase No" %}", type: "text", css: "text-center", width: 40 },
                { name: "version_no", title: "{% trans "Version No" %}", type: "text", css: "text-center", width: 25 },
                { name: "version_seq", title: "{% trans "Version Seq" %}", type: "text", css: "text-center", width: 25 },
                { name: "size", title: "{% trans "Size" %}", type: "text", css: "text-center", width: 25 },
                { name: "bin", title: "{% trans "Bin" %}", type: "text", css: "text-center", width: 25 },
                { name: "qty", title: "{% trans "Qty" %}", type: "number", width: 25 },
                {
                    type: "control",
                    itemTemplate: function(_, item) {
                        return $("<button>").text("{% trans "Transfer" %}")
                            .addClass("btn btn-warning")
                            .on("click", function() {
                                let queryParams = $.param({
                                    warehouse: item.bin__area__warehouse__wh_code,
                                    product_order: item.product_order,
                                    purchase_no: item.purchase_no,
                                    version_no: item.version_no,
                                    version_seq: item.version_seq,
                                    size: item.size,
                                    bin: item.bin,
                                    qty: item.qty,
                                    search: $("#workOrder").val()
                                });

                                window.open("/warehouse/bin_transfer_page?" + queryParams, "");
                        });
                    }
                },
                {
                    type: "control",
                    width: 30,
                    itemTemplate: function(_, item) {
                        return $("<button>").text("{% trans "Adjust" %}")
                            .addClass("btn btn-warning")
                            .on("click", function() {
                                let queryParams = $.param({
                                    warehouse: item.bin__area__warehouse__wh_code,
                                    product_order: item.product_order,
                                    purchase_no: item.purchase_no,
                                    version_no: item.version_no,
                                    version_seq: item.version_seq,
                                    size: item.size,
                                    bin: item.bin,
                                    qty: item.qty,
                                    search: $("#workOrder").val()
                                });

                                window.open("/warehouse/bin_adjust_page?" + queryParams, "");
                        });
                    }
                }
            ]
        });


        $("#searchBtn").on("click", function() {
            const workOrder = $("#workOrder").val();

            $.ajax({
                url: '{% url "work_order_search" %}?product_order=' + encodeURIComponent(workOrder),
                method: 'GET',
                dataType: 'json',
                success: function(response) {
                    $("#jsGrid").jsGrid("option", "data", response);
                },
                error: function(xhr, status, error) {
                    console.log('Error: ' + error);
                }
            });

        });
    });

</script>
{% endblock %}
{% block content %}
    <div style="padding-left: 7rem; padding-right: 7rem;">
        <h3 style="font-size: 1.5em;text-align: center;" class="mt-4">{% trans "Search By Work Order" %}</h3>
        <div class="mt-5">
            <input type="text" id="workOrder" placeholder="{% trans "Work Order Id" %}">
            <button id="searchBtn" class="btn btn-primary"><i class="fas fa-search"></i> {% trans "Search" %}</button>
        </div>
        <div class="mt-2" id="jsGrid"></div>
    </div>

{% endblock %}
